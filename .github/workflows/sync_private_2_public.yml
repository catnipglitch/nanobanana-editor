name: Sync to Public Repository

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo (source)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone public repository (destination)
        run: |
          git clone https://github.com/${{ github.repository_owner }}/nanobanana-editor public

      - name: Clean public repo content (avoid nested public/public issue)
        run: |
          cd public
          # Remove everything except .git directory
          find . -mindepth 1 -maxdepth 1 ! -name ".git" ! -name ".github" -exec rm -rf {} +
      - name: Sync files from private â†’ public (rsync with excludes)
        run: |
          rsync -av \
            --exclude=".private/" \
            --exclude=".github/agents/" \
            --exclude=".claude/" \
            --exclude="samples/sample_images/" \
            --exclude="AGENTS.md" \
            --exclude="GEMINI.md" \
            --exclude="CLAUDE.md" \
            --exclude=".git/" \
            --exclude=".env" \
            --exclude="output/" \
            ./ public/

      - name: Commit & Push to public
        working-directory: public
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git add -A
          if git diff-index --quiet HEAD; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Sync from private repo"
          git remote set-url origin https://${{ github.repository_owner }}:${{ secrets.PUBLIC_REPO_PAT }}@github.com/${{ github.repository_owner }}/nanobanana-editor.git
          git push origin main --force
