"""
Gradio UI Application

nanobabana-editorã®Gradioã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€‚
3ã¤ã®ã‚¿ãƒ–ã§æ§‹æˆ:
- Tab 1: ç”»åƒç”Ÿæˆ
- Tab 2: ç”»åƒç·¨é›†
- Tab 3: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ç·¨é›†
"""

import gradio as gr
import os
import sys
import logging
from pathlib import Path
from dotenv import load_dotenv
from PIL import Image
import io
from typing import Optional

# ãƒ­ã‚®ãƒ³ã‚°è¨­å®š
logger = logging.getLogger(__name__)
if not logger.handlers:
    handler = logging.StreamHandler()
    formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    logger.setLevel(logging.INFO)

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from src.core.image_generator import (
    ImageGenerator, GenerationConfig, ModelType,
    GeminiImageGenerator, ImagenImageGenerator, TestImageGenerator
)
from src.core.output_manager import OutputManager
from src.core.prompt_templates import PromptTemplateManager
from src.core.model_specs import ModelRegistry, GeminiModelRegistry, ImagenModelRegistry

# ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
load_dotenv()


class NanobabanaApp:
    """nanobabana-editorã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"""

    def __init__(self, test_mode: bool = False):
        """
        åˆæœŸåŒ–

        Args:
            test_mode: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆAPIã‚­ãƒ¼ãªã—ã§UIã®ã¿èµ·å‹•ï¼‰
        """
        self.test_mode = test_mode

        # èªè¨¼æƒ…å ±ã‚’å–å¾—
        use_vertexai_str = os.getenv("GOOGLE_GENAI_USE_VERTEXAI", "true").lower()
        self.use_vertexai = use_vertexai_str in ("true", "1", "yes")
        self.gcp_project_id = os.getenv("GCP_PROJECT_ID")
        self.gcp_location = os.getenv("GCP_LOCATION", "us-central1")
        self.google_api_key = os.getenv("GOOGLE_API_KEY")

        # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã®ã¿ã€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
        if not test_mode:
            # æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: åˆ†é›¢ã•ã‚ŒãŸã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿
            self.gemini_generator = GeminiImageGenerator(google_api_key=self.google_api_key)
            self.imagen_generator = ImagenImageGenerator(google_api_key=self.google_api_key)
            self.test_generator = TestImageGenerator(google_api_key="dummy_key_for_test")

            # å¾Œæ–¹äº’æ›æ€§: æ—¢å­˜ã®generatorã‚‚ç¶­æŒ
            self.generator = ImageGenerator(
                use_vertexai=self.use_vertexai,
                gcp_project_id=self.gcp_project_id,
                gcp_location=self.gcp_location,
                google_api_key=self.google_api_key
            )
        else:
            self.gemini_generator = None
            self.imagen_generator = None
            self.test_generator = None
            self.generator = None
            print("âš  ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™")

        self.output_manager = OutputManager(output_dir="output")
        self.template_manager = PromptTemplateManager()

        # Geminiã‚¿ãƒ–ç”¨ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ
        self.gemini_models = GeminiModelRegistry.get_model_ids()

        # Imagenã‚¿ãƒ–ç”¨ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ
        self.imagen_models = ImagenModelRegistry.get_model_ids()

        # å¾Œæ–¹äº’æ›æ€§: çµ±åˆãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ
        self.all_models = (
            ["--- Test Models ---"] +
            ImageGenerator.TEST_MODELS +
            ["--- Gemini Models ---"] +
            ImageGenerator.GEMINI_MODELS +
            ["--- Imagen Models ---"] +
            ImageGenerator.IMAGEN_MODELS
        )

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        self.default_imagen_config = {
            "aspect_ratio": "1:1",
            "number_of_images": 1,
            "seed": None,
            "enhance_prompt": False,
            "add_watermark": False,
            "safety_filter": "block_some",
            "person_generation": "allow_adult",
        }

        self.default_gemini_config = {
            # Geminiç‰¹æœ‰ã®è¨­å®šï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
        }

    def generate_image(
        self,
        prompt: str,
        model_name: str,
        # Imagenå›ºæœ‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        aspect_ratio: str,
        number_of_images: int,
        seed_enabled: bool,
        seed_value: int,
        enhance_prompt: bool,
        add_watermark: bool,
        safety_filter: str,
        person_generation: str,
    ):
        """
        ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ï¼ˆTab 1ç”¨ï¼‰

        Returns:
            (single_image, gallery_images, single_visible, gallery_visible, info_text, json_log):
            - single_image: å˜ä¸€ç”»åƒï¼ˆImageç”¨ï¼‰
            - gallery_images: è¤‡æ•°ç”»åƒï¼ˆGalleryç”¨ï¼‰
            - single_visible: Imageã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¡¨ç¤º/éè¡¨ç¤º
            - gallery_visible: Galleryã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¡¨ç¤º/éè¡¨ç¤º
            - info_text: æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆ
            - json_log: JSONãƒ­ã‚°
        """
        if self.test_mode:
            return None, None, gr.update(visible=True), gr.update(visible=False), """ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰

ã“ã®ã‚¢ãƒ—ãƒªã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚
ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„:

1. `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¨­å®š:

   **APIã‚­ãƒ¼èªè¨¼æ–¹å¼ï¼ˆæ¨å¥¨ï¼‰:**
   ```
   GOOGLE_GENAI_USE_VERTEXAI=true
   GOOGLE_API_KEY=your-api-key
   ```

   **ADCèªè¨¼æ–¹å¼:**
   ```
   GOOGLE_GENAI_USE_VERTEXAI=false
   GCP_PROJECT_ID=your-project-id
   GCP_LOCATION=us-central1
   ```

2. é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•:
   ```bash
   python app.py
   ```
""", ""

        if not prompt:
            return None, None, gr.update(visible=True), gr.update(visible=False), "âš  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", ""

        try:
            # ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
            model_type = ImageGenerator.get_model_type(model_name)

            # èªè¨¼æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯ï¼ˆTest Modelã¯é™¤ãï¼‰
            if model_type == ModelType.IMAGEN:
                if self.use_vertexai and not self.google_api_key:
                    return None, None, gr.update(visible=True), gr.update(visible=False), "âŒ ã‚¨ãƒ©ãƒ¼: GOOGLE_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆAPIã‚­ãƒ¼èªè¨¼ãƒ¢ãƒ¼ãƒ‰ï¼‰", ""
                elif not self.use_vertexai and not self.gcp_project_id:
                    return None, None, gr.update(visible=True), gr.update(visible=False), "âŒ ã‚¨ãƒ©ãƒ¼: GCP_PROJECT_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆADCèªè¨¼ãƒ¢ãƒ¼ãƒ‰ï¼‰", ""

            if model_type == ModelType.GEMINI and not self.google_api_key:
                return None, None, gr.update(visible=True), gr.update(visible=False), "âŒ ã‚¨ãƒ©ãƒ¼: GOOGLE_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“", ""

            # seedã®å‡¦ç†
            seed = int(seed_value) if seed_enabled and seed_value is not None else None

            # seed ã¨ watermark ã®æ’ä»–åˆ¶å¾¡ï¼ˆäºŒé‡ãƒã‚§ãƒƒã‚¯ï¼‰
            if seed is not None and add_watermark:
                return None, None, gr.update(visible=True), gr.update(visible=False), "âŒ ã‚¨ãƒ©ãƒ¼: seedã¨add_watermarkã¯åŒæ™‚ã«ä½¿ç”¨ã§ãã¾ã›ã‚“", ""

            # ç”Ÿæˆè¨­å®šã‚’ä½œæˆ
            config = GenerationConfig(
                model_type=model_type,
                model_name=model_name,
                prompt=prompt,
                aspect_ratio=aspect_ratio,
                number_of_images=int(number_of_images),
                seed=seed,
                enhance_prompt=enhance_prompt,
                add_watermark=add_watermark,
                safety_filter_level=safety_filter,
                person_generation=person_generation,
            )

            # ç”»åƒã‚’ç”Ÿæˆ
            logger.info(f"Starting image generation: model={model_name}, number_of_images={number_of_images}")
            image_data_list, metadata = self.generator.generate(config)
            logger.info(f"Image generation successful: {len(image_data_list)} images generated")

            # ç”»åƒã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            image_paths, metadata_path = self.output_manager.save_images_with_metadata(
                image_data_list=image_data_list,
                metadata=metadata,
                prefix="gradio_gen",
                extension="png"
            )

            # PIL Imageã«å¤‰æ›
            pil_images = [Image.open(io.BytesIO(data)) for data in image_data_list]
            logger.info(f"Converted {len(pil_images)} images to PIL format")

            # æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
            total_size = sum(len(data) for data in image_data_list)
            info_text = f"""âœ“ ç”»åƒç”Ÿæˆå®Œäº†!

**ãƒ¢ãƒ‡ãƒ«**: {model_name}
**ç”Ÿæˆæšæ•°**: {len(pil_images)}
**ãƒ•ã‚¡ã‚¤ãƒ«**: {', '.join([p.name for p in image_paths])}
**åˆè¨ˆã‚µã‚¤ã‚º**: {total_size:,} ãƒã‚¤ãƒˆ
**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: {metadata_path.name}
"""

            if seed is not None:
                info_text += f"**ä½¿ç”¨ã—ãŸseed**: {seed}\n"

            # JSONãƒ­ã‚°ã‚’ç”Ÿæˆ
            import json
            json_log = json.dumps(metadata, ensure_ascii=False, indent=2)

            # å˜ä¸€ç”»åƒã®å ´åˆã¯Imageã§ã€è¤‡æ•°ã®å ´åˆã¯Galleryã§è¿”ã™
            if len(pil_images) == 1:
                # å˜ä¸€ç”»åƒ: Imageã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¡¨ç¤ºã€Galleryã‚’éè¡¨ç¤º
                logger.info("Returning single image via Image component")
                return pil_images[0], None, gr.update(visible=True), gr.update(visible=False), info_text, json_log
            else:
                # è¤‡æ•°ç”»åƒ: Imageã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’éè¡¨ç¤ºã€Galleryã‚’è¡¨ç¤º
                logger.info(f"Returning {len(pil_images)} images via Gallery component")
                return None, pil_images, gr.update(visible=False), gr.update(visible=True), info_text, json_log

        except Exception as e:
            logger.error(f"Image generation failed: {e}", exc_info=True)
            error_text = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
            return None, None, gr.update(visible=True), gr.update(visible=False), error_text, ""

    def apply_template(self, template_name: str):
        """
        ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨

        Note: ãƒ¢ãƒ‡ãƒ«è¨­å®šã¯ç„¡è¦–ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿é©ç”¨

        Returns:
            prompt: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆ
        """
        if template_name == "é¸æŠã—ã¦ãã ã•ã„":
            return ""

        template = self.template_manager.get_template_by_name(template_name)
        if template:
            return template.prompt
        else:
            return ""

    def reset_settings(self, model_name: str):
        """
        è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ

        Returns:
            å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        """
        model_type = ImageGenerator.get_model_type(model_name)

        if model_type == ModelType.IMAGEN:
            return (
                "",  # prompt
                self.default_imagen_config["aspect_ratio"],
                self.default_imagen_config["number_of_images"],
                False,  # seed_enabled
                0,  # seed_value
                self.default_imagen_config["enhance_prompt"],
                self.default_imagen_config["add_watermark"],
                self.default_imagen_config["safety_filter"],
                self.default_imagen_config["person_generation"],
            )
        else:  # Gemini
            return (
                "",  # prompt
                self.default_imagen_config["aspect_ratio"],
                1,  # number_of_images (Gemini ã¯å¸¸ã«1)
                False,  # seed_enabled
                0,  # seed_value
                False,  # enhance_prompt
                False,  # add_watermark
                self.default_imagen_config["safety_filter"],
                self.default_imagen_config["person_generation"],
            )

    def toggle_seed_watermark(self, seed_enabled: bool, add_watermark: bool, changed_component: str):
        """
        seed ã¨ watermark ã®æ’ä»–åˆ¶å¾¡

        Args:
            seed_enabled: seedãŒæœ‰åŠ¹ã‹
            add_watermark: watermarkãŒæœ‰åŠ¹ã‹
            changed_component: ã©ã¡ã‚‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ ("seed" or "watermark")

        Returns:
            (seed_enabled, add_watermark, warning_message)
        """
        warning = ""

        if changed_component == "seed":
            if seed_enabled and add_watermark:
                add_watermark = False
                warning = "âš  æ³¨æ„: seedã‚’æœ‰åŠ¹ã«ã—ãŸãŸã‚ã€add_watermarkã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ"
        elif changed_component == "watermark":
            if add_watermark and seed_enabled:
                seed_enabled = False
                warning = "âš  æ³¨æ„: add_watermarkã‚’æœ‰åŠ¹ã«ã—ãŸãŸã‚ã€seedã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ"

        return seed_enabled, add_watermark, warning

    def update_ui_for_model(self, model_name: str, current_number_of_images: int):
        """
        ãƒ¢ãƒ‡ãƒ«é¸æŠã«å¿œã˜ã¦UIã‚’æ›´æ–°

        Args:
            model_name: é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«å
            current_number_of_images: ç¾åœ¨ã®number_of_imageså€¤

        Returns:
            å„UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ›´æ–°æƒ…å ±ï¼ˆã‚¿ãƒ—ãƒ«å½¢å¼ï¼‰
        """
        # ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if model_name.startswith("---"):
            return tuple([gr.update()] * 7)

        try:
            model_type = ImageGenerator.get_model_type(model_name)
        except ValueError:
            # ä¸æ˜ãªãƒ¢ãƒ‡ãƒ«ã®å ´åˆã¯Imagenã¨ã—ã¦æ‰±ã†
            model_type = ModelType.IMAGEN

        # ãƒ¢ãƒ‡ãƒ«ä»•æ§˜ã‹ã‚‰æœ€å¤§ç”»åƒæšæ•°ã‚’å–å¾—
        max_images = ModelRegistry.get_max_number_of_images(model_name)

        # ç¾åœ¨ã®å€¤ãŒæœ€å¤§å€¤ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯æœ€å¤§å€¤ã«èª¿æ•´
        adjusted_number_of_images = min(current_number_of_images, max_images)

        if model_type == ModelType.TEST:
            # Test Model: å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            return (
                gr.update(visible=True),   # aspect_ratio
                gr.update(visible=True, maximum=max_images, value=adjusted_number_of_images),  # number_of_images
                gr.update(visible=True),   # seed_row
                gr.update(visible=True),   # enhance_prompt
                gr.update(visible=True),   # add_watermark
                gr.update(visible=True),   # safety_filter
                gr.update(visible=True),   # person_generation
            )
        elif model_type == ModelType.IMAGEN:
            # Imagen: ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            return (
                gr.update(visible=True),   # aspect_ratio
                gr.update(visible=True, maximum=max_images, value=adjusted_number_of_images),  # number_of_images
                gr.update(visible=True),   # seed_row
                gr.update(visible=True),   # enhance_prompt
                gr.update(visible=True),   # add_watermark
                gr.update(visible=True),   # safety_filter
                gr.update(visible=True),   # person_generation
            )
        else:  # Gemini
            # Gemini: åŸºæœ¬çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãªã©ï¼‰
            # number_of_imagesã¯1å›ºå®šã€Imagenå›ºæœ‰ã®æ©Ÿèƒ½ã¯éè¡¨ç¤º
            return (
                gr.update(visible=True),   # aspect_ratio (Gemini also supports)
                gr.update(visible=False, maximum=max_images, value=1),  # number_of_images (Gemini: 1 only)
                gr.update(visible=False),  # seed_row (Imagen only)
                gr.update(visible=False),  # enhance_prompt (Imagen only)
                gr.update(visible=False),  # add_watermark (Imagen only)
                gr.update(visible=False),  # safety_filter (Imagen only)
                gr.update(visible=False),  # person_generation (Imagen only)
            )

    def generate_gemini_image(
        self,
        prompt: str,
        model_name: str,
        aspect_ratio: str,
    ):
        """
        Geminiã§ç”»åƒã‚’ç”Ÿæˆï¼ˆTab 1: Geminiå°‚ç”¨ï¼‰

        Returns:
            (image, info_text, json_log): ç”Ÿæˆã•ã‚ŒãŸç”»åƒã€æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆã€JSONãƒ­ã‚°
        """
        logger.info(f"=== Gemini Tab: Image Generation Request ===")

        if self.test_mode or self.gemini_generator is None:
            return None, "âš  ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™", ""

        # èªè¨¼ãƒã‚§ãƒƒã‚¯
        if not self.google_api_key:
            error_text = "âŒ ã‚¨ãƒ©ãƒ¼: GOOGLE_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            logger.error(error_text)
            return None, error_text, ""

        try:
            # Geminiå›ºæœ‰ã®è¨­å®š
            config = GenerationConfig(
                model_type=ModelType.GEMINI if model_name == "gemini-2.5-flash-image" else ModelType.TEST,
                model_name=model_name,
                prompt=prompt,
                aspect_ratio=aspect_ratio,
                number_of_images=1,  # Geminiã¯å¸¸ã«1æš
            )

            # ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’é¸æŠ
            if model_name == "test-model":
                generator = self.test_generator
            else:
                generator = self.gemini_generator

            # ç”»åƒç”Ÿæˆ
            image_data_list, metadata = generator.generate(config)

            # PIL Imageã«å¤‰æ›
            pil_image = Image.open(io.BytesIO(image_data_list[0]))

            # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
            saved_files = self.output_manager.save_image_with_metadata(
                image_data=image_data_list[0],
                metadata=metadata,
                prefix="gemini_gen"
            )

            # æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            info_text = f"### ç”Ÿæˆå®Œäº† âœ…\n\n"
            info_text += f"**ãƒ¢ãƒ‡ãƒ«**: {model_name}\n"
            info_text += f"**ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«**: `{saved_files['image_file']}`\n"
            info_text += f"**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: `{saved_files['metadata_file']}`\n"
            info_text += f"**ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: {len(image_data_list[0]) / 1024:.1f} KB\n"

            # JSONãƒ­ã‚°
            import json
            json_log = json.dumps(metadata, ensure_ascii=False, indent=2)

            logger.info(f"=== Gemini Tab: Image Generation Complete ===")
            return pil_image, info_text, json_log

        except Exception as e:
            logger.error(f"Gemini image generation failed: {e}", exc_info=True)
            error_text = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
            return None, error_text, ""

    def generate_imagen_image(
        self,
        prompt: str,
        model_name: str,
        aspect_ratio: str,
        number_of_images: int,
        seed_enabled: bool,
        seed_value: int,
        enhance_prompt: bool,
        add_watermark: bool,
        safety_filter_level: str,
        person_generation: str,
    ):
        """
        Imagenã§ç”»åƒã‚’ç”Ÿæˆï¼ˆTab 2: Imagenå°‚ç”¨ï¼‰

        Returns:
            (single_image, gallery_images, single_visible, gallery_visible, info_text, json_log):
            å˜ä¸€ç”»åƒã€è¤‡æ•°ç”»åƒã€è¡¨ç¤ºåˆ¶å¾¡ã€æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆã€JSONãƒ­ã‚°
        """
        logger.info(f"=== Imagen Tab: Image Generation Request ===")

        if self.test_mode or self.imagen_generator is None:
            return None, None, gr.update(visible=True), gr.update(visible=False), "âš  ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™", ""

        # èªè¨¼ãƒã‚§ãƒƒã‚¯
        if not self.google_api_key:
            error_text = "âŒ ã‚¨ãƒ©ãƒ¼: GOOGLE_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            logger.error(error_text)
            return None, None, gr.update(visible=True), gr.update(visible=False), error_text, ""

        try:
            # Imagenå›ºæœ‰ã®è¨­å®š
            config = GenerationConfig(
                model_type=ModelType.IMAGEN if model_name.startswith("imagen") else ModelType.TEST,
                model_name=model_name,
                prompt=prompt,
                aspect_ratio=aspect_ratio,
                number_of_images=number_of_images,
                seed=seed_value if seed_enabled else None,
                enhance_prompt=enhance_prompt,
                add_watermark=add_watermark,
                safety_filter_level=safety_filter_level,
                person_generation=person_generation,
            )

            # ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’é¸æŠ
            if model_name == "test-model":
                generator = self.test_generator
            else:
                generator = self.imagen_generator

            # ç”»åƒç”Ÿæˆ
            image_data_list, metadata = generator.generate(config)

            # PIL Imageã«å¤‰æ›
            pil_images = [Image.open(io.BytesIO(data)) for data in image_data_list]

            # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
            if len(image_data_list) == 1:
                saved_files = self.output_manager.save_image_with_metadata(
                    image_data=image_data_list[0],
                    metadata=metadata,
                    prefix="imagen_gen"
                )
                image_files = [saved_files['image_file']]
            else:
                saved_files = self.output_manager.save_images_with_metadata(
                    image_data_list=image_data_list,
                    metadata=metadata,
                    prefix="imagen_gen"
                )
                image_files = saved_files['image_files']

            # æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            info_text = f"### ç”Ÿæˆå®Œäº† âœ…\n\n"
            info_text += f"**ãƒ¢ãƒ‡ãƒ«**: {model_name}\n"
            info_text += f"**ç”Ÿæˆæšæ•°**: {len(pil_images)}æš\n"

            if len(image_files) == 1:
                info_text += f"**ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«**: `{image_files[0]}`\n"
                info_text += f"**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: `{saved_files['metadata_file']}`\n"
                info_text += f"**ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: {len(image_data_list[0]) / 1024:.1f} KB\n"
            else:
                info_text += f"**ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«**: \n"
                for i, img_file in enumerate(image_files):
                    info_text += f"  - `{img_file}`\n"
                info_text += f"**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: `{saved_files['metadata_file']}`\n"

            if seed_enabled:
                info_text += f"**ä½¿ç”¨ã—ãŸseed**: {seed_value}\n"

            # JSONãƒ­ã‚°
            import json
            json_log = json.dumps(metadata, ensure_ascii=False, indent=2)

            # å˜ä¸€ç”»åƒ/è¤‡æ•°ç”»åƒã§å‡ºåŠ›ã‚’åˆ‡ã‚Šæ›¿ãˆ
            if len(pil_images) == 1:
                logger.info("Returning single image via Image component")
                return pil_images[0], None, gr.update(visible=True), gr.update(visible=False), info_text, json_log
            else:
                logger.info(f"Returning {len(pil_images)} images via Gallery component")
                return None, pil_images, gr.update(visible=False), gr.update(visible=True), info_text, json_log

        except Exception as e:
            logger.error(f"Imagen image generation failed: {e}", exc_info=True)
            error_text = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
            return None, None, gr.update(visible=True), gr.update(visible=False), error_text, ""

    def edit_image(
        self,
        input_image: Image.Image,
        operation: str,
    ):
        """
        ç”»åƒã‚’ç·¨é›†ã™ã‚‹ï¼ˆTab 3ç”¨ï¼‰
        """
        if input_image is None:
            return None, "âš  ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"

        try:
            edited_image = input_image.copy()

            if operation == "left_right_flip":
                edited_image = edited_image.transpose(Image.FLIP_LEFT_RIGHT)
            elif operation == "top_bottom_flip":
                edited_image = edited_image.transpose(Image.FLIP_TOP_BOTTOM)
            elif operation == "rotate_90":
                edited_image = edited_image.rotate(90, expand=True)
            elif operation == "rotate_180":
                edited_image = edited_image.rotate(180)
            elif operation == "rotate_270":
                edited_image = edited_image.rotate(270, expand=True)
            elif operation == "grayscale":
                edited_image = edited_image.convert("L").convert("RGB")
            else:
                return input_image, "âš  ä¸æ˜ãªç·¨é›†æ“ä½œã§ã™"

            # ç”»åƒã‚’ä¿å­˜
            img_byte_arr = io.BytesIO()
            edited_image.save(img_byte_arr, format='PNG')
            image_data = img_byte_arr.getvalue()

            metadata = {
                "operation": operation,
                "original_size": input_image.size,
                "edited_size": edited_image.size,
            }

            image_paths, metadata_path = self.output_manager.save_images_with_metadata(
                image_data_list=[image_data],
                metadata=metadata,
                prefix="gradio_edit",
                extension="png"
            )

            info_text = f"""âœ“ ç·¨é›†å®Œäº†!

**æ“ä½œ**: {operation}
**ãƒ•ã‚¡ã‚¤ãƒ«**: {image_paths[0].name}
**ã‚µã‚¤ã‚º**: {len(image_data):,} ãƒã‚¤ãƒˆ
"""

            return edited_image, info_text

        except Exception as e:
            error_text = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
            return None, error_text

    def agent_assisted_edit(
        self,
        input_image: Image.Image,
        instruction: str,
    ):
        """
        ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ã§ç”»åƒã‚’ç·¨é›†ã™ã‚‹ï¼ˆTab 3ç”¨ï¼‰
        """
        return input_image, """ğŸš§ å®Ÿè£…äºˆå®š

ã“ã®ã‚¿ãƒ–ã¯å°†æ¥çš„ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹äºˆå®šã§ã™ã€‚
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæŒ‡ç¤ºã‚’ç†è§£ã—ã€é©åˆ‡ãªç”»åƒç·¨é›†ã‚’è¡Œã„ã¾ã™ã€‚
"""

    def create_ui(self):
        """Gradio UIã‚’ä½œæˆï¼ˆ4ã‚¿ãƒ–æ§‹æˆï¼‰"""
        with gr.Blocks(title="nanobabana-editor", theme=gr.themes.Soft()) as demo:
            gr.Markdown("# nanobabana-editor")
            gr.Markdown("ç”»åƒç”Ÿæˆãƒ»ç·¨é›†ãƒ„ãƒ¼ãƒ« - Gemini & Imagen å®Œå…¨åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£")

            with gr.Tabs():
                # Tab 1: ç”»åƒç”Ÿæˆï¼ˆGeminiï¼‰
                with gr.Tab("ç”»åƒç”Ÿæˆï¼ˆGeminiï¼‰"):
                    with gr.Row():
                        with gr.Column(scale=1):
                            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢
                            gen_template = gr.Dropdown(
                                label="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
                                choices=self.template_manager.get_template_choices(),
                                value="é¸æŠã—ã¦ãã ã•ã„",
                                info="ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠ"
                            )

                            gen_prompt = gr.Textbox(
                                label="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ",
                                placeholder="ç”Ÿæˆã—ãŸã„ç”»åƒã‚’èª¬æ˜ã—ã¦ãã ã•ã„",
                                lines=4
                            )

                            gen_model = gr.Dropdown(
                                label="ãƒ¢ãƒ‡ãƒ«",
                                choices=self.all_models,
                                value="gemini-2.5-flash-image",
                                info="ç”»åƒç”Ÿæˆã«ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«"
                            )

                            # è©³ç´°è¨­å®šï¼ˆAccordion - åˆæœŸçŠ¶æ…‹: é–‹ï¼‰
                            with gr.Accordion("è©³ç´°è¨­å®š", open=True):
                                # è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                                gen_warning = gr.Markdown(value="", visible=True)

                                # ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”è¨­å®šï¼ˆGemini/Imagenå…±é€šï¼‰
                                gen_aspect_ratio = gr.Dropdown(
                                    label="ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”",
                                    choices=["1:1", "9:16", "16:9", "4:3", "3:4"],
                                    value="1:1",
                                    info="ç”Ÿæˆç”»åƒã®ç¸¦æ¨ªæ¯”",
                                    visible=True  # åˆæœŸãƒ¢ãƒ‡ãƒ«(Gemini)ã§ã‚‚è¡¨ç¤º
                                )

                                gen_number_of_images = gr.Slider(
                                    label="ç”»åƒæšæ•°",
                                    minimum=1,
                                    maximum=8,
                                    step=1,
                                    value=1,
                                    info="ä¸€åº¦ã«ç”Ÿæˆã™ã‚‹ç”»åƒã®æ•°ï¼ˆImagenç”¨ï¼‰",
                                    visible=False
                                )

                                with gr.Row(visible=False) as gen_seed_row:
                                    gen_seed_enabled = gr.Checkbox(
                                        label="Seedæœ‰åŠ¹åŒ–",
                                        value=False,
                                        info="å†ç¾æ€§ã®ãŸã‚ã®ä¹±æ•°ã‚·ãƒ¼ãƒ‰ï¼ˆadd_watermarkã¨æ’ä»–çš„ï¼‰"
                                    )
                                    gen_seed_value = gr.Number(
                                        label="Seedå€¤",
                                        value=0,
                                        precision=0,
                                        info="æ•´æ•°å€¤ã‚’å…¥åŠ›"
                                    )

                                gen_enhance_prompt = gr.Checkbox(
                                    label="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè‡ªå‹•æ‹¡å¼µ",
                                    value=False,
                                    info="AIãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è©³ç´°åŒ–ãƒ»æ”¹å–„ï¼ˆImagenç”¨ï¼‰",
                                    visible=False
                                )

                                gen_add_watermark = gr.Checkbox(
                                    label="é€ã‹ã—è¿½åŠ ",
                                    value=False,
                                    info="ç”Ÿæˆç”»åƒã«é€ã‹ã—ã‚’è¿½åŠ ï¼ˆseedã¨æ’ä»–çš„ã€Imagenç”¨ï¼‰",
                                    visible=False
                                )

                                gen_safety_filter = gr.Dropdown(
                                    label="å®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¬ãƒ™ãƒ«",
                                    choices=[
                                        ("æœ€å¼·ãƒ•ã‚£ãƒ«ã‚¿ - æœ€ã‚‚å³æ ¼ (block_low_and_above / æ—§:block_most)", "block_low_and_above"),
                                        ("æ¨™æº–ãƒ•ã‚£ãƒ«ã‚¿ - ä¸€éƒ¨ãƒ–ãƒ­ãƒƒã‚¯ (block_medium_and_above / æ—§:block_some)", "block_medium_and_above"),
                                        ("å¼±ã„ãƒ•ã‚£ãƒ«ã‚¿ - ãƒ–ãƒ­ãƒƒã‚¯å°‘ãªã‚ (block_only_high / æ—§:block_few)", "block_only_high"),
                                        ("æœ€å¼±ãƒ•ã‚£ãƒ«ã‚¿ - ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚ã‚Š (block_none / æ—§:block_fewest) â€»æ©Ÿèƒ½ã—ãªã„å¯èƒ½æ€§ã‚ã‚Š", "block_none")
                                    ],
                                    value="block_only_high",
                                    info="ä¸é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¼·åº¦ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯block_medium_and_aboveï¼ˆImagenç”¨ï¼‰",
                                    visible=False
                                )

                                gen_person_generation = gr.Dropdown(
                                    label="äººç‰©ç”Ÿæˆ",
                                    choices=[
                                        ("æˆäººã®ã¿è¨±å¯ (allow_adult)", "allow_adult"),
                                        ("ã™ã¹ã¦è¨±å¯ (allow_all)", "allow_all"),
                                        ("äººç‰©ãªã— (block_all)", "block_all")
                                    ],
                                    value="allow_adult",
                                    info="äººç‰©ç”»åƒã®ç”Ÿæˆè¨±å¯ãƒ¬ãƒ™ãƒ«ï¼ˆImagenç”¨ï¼‰",
                                    visible=False
                                )

                            # ãƒœã‚¿ãƒ³
                            with gr.Row():
                                gen_button = gr.Button("ç”»åƒã‚’ç”Ÿæˆ", variant="primary", scale=2)
                                reset_button = gr.Button("ãƒªã‚»ãƒƒãƒˆ", variant="secondary", scale=1)

                        with gr.Column(scale=1):
                            gen_output_image = gr.Image(label="ç”Ÿæˆã•ã‚ŒãŸç”»åƒ", type="pil")
                            gen_output_gallery = gr.Gallery(label="ç”Ÿæˆã•ã‚ŒãŸç”»åƒï¼ˆè¤‡æ•°ï¼‰", visible=False)
                            gen_output_info = gr.Markdown()

                            # JSONãƒ­ã‚°è¡¨ç¤º
                            with gr.Accordion("JSONãƒ­ã‚°ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰", open=False):
                                gen_output_json = gr.Code(
                                    label="",
                                    language="json",
                                    lines=15,
                                    value=""
                                )

                    # ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©

                    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã¿æ›´æ–°ã€ãƒ¢ãƒ‡ãƒ«ã¯å¤‰æ›´ã—ãªã„ï¼‰
                    gen_template.change(
                        fn=self.apply_template,
                        inputs=[gen_template],
                        outputs=[gen_prompt]
                    )

                    # ãƒ¢ãƒ‡ãƒ«é¸æŠæ™‚ã«UIã‚’åˆ‡ã‚Šæ›¿ãˆ
                    gen_model.change(
                        fn=self.update_ui_for_model,
                        inputs=[gen_model, gen_number_of_images],
                        outputs=[
                            gen_aspect_ratio,
                            gen_number_of_images,
                            gen_seed_row,
                            gen_enhance_prompt,
                            gen_add_watermark,
                            gen_safety_filter,
                            gen_person_generation,
                        ]
                    )

                    # seed/watermark æ’ä»–åˆ¶å¾¡
                    gen_seed_enabled.change(
                        fn=lambda s, w: self.toggle_seed_watermark(s, w, "seed"),
                        inputs=[gen_seed_enabled, gen_add_watermark],
                        outputs=[gen_seed_enabled, gen_add_watermark, gen_warning]
                    )

                    gen_add_watermark.change(
                        fn=lambda s, w: self.toggle_seed_watermark(s, w, "watermark"),
                        inputs=[gen_seed_enabled, gen_add_watermark],
                        outputs=[gen_seed_enabled, gen_add_watermark, gen_warning]
                    )

                    # ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
                    reset_button.click(
                        fn=self.reset_settings,
                        inputs=[gen_model],
                        outputs=[
                            gen_prompt,
                            gen_aspect_ratio,
                            gen_number_of_images,
                            gen_seed_enabled,
                            gen_seed_value,
                            gen_enhance_prompt,
                            gen_add_watermark,
                            gen_safety_filter,
                            gen_person_generation,
                        ]
                    )

                    # ç”»åƒç”Ÿæˆ
                    gen_button.click(
                        fn=self.generate_image,
                        inputs=[
                            gen_prompt,
                            gen_model,
                            gen_aspect_ratio,
                            gen_number_of_images,
                            gen_seed_enabled,
                            gen_seed_value,
                            gen_enhance_prompt,
                            gen_add_watermark,
                            gen_safety_filter,
                            gen_person_generation,
                        ],
                        outputs=[
                            gen_output_image,
                            gen_output_gallery,
                            gen_output_image,  # visible update
                            gen_output_gallery,  # visible update
                            gen_output_info,
                            gen_output_json
                        ]
                    )

                # Tab 2: ç”»åƒç·¨é›†
                with gr.Tab("ç”»åƒç·¨é›†"):
                    with gr.Row():
                        with gr.Column():
                            edit_input_image = gr.Image(
                                label="å…¥åŠ›ç”»åƒ",
                                type="pil"
                            )
                            edit_operation = gr.Radio(
                                label="ç·¨é›†æ“ä½œ",
                                choices=[
                                    ("å·¦å³åè»¢", "left_right_flip"),
                                    ("ä¸Šä¸‹åè»¢", "top_bottom_flip"),
                                    ("90åº¦å›è»¢", "rotate_90"),
                                    ("180åº¦å›è»¢", "rotate_180"),
                                    ("270åº¦å›è»¢", "rotate_270"),
                                    ("ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«", "grayscale"),
                                ],
                                value="left_right_flip"
                            )
                            edit_button = gr.Button("ç·¨é›†ã‚’å®Ÿè¡Œ", variant="primary")

                        with gr.Column():
                            edit_output_image = gr.Image(label="ç·¨é›†å¾Œã®ç”»åƒ")
                            edit_output_info = gr.Markdown()

                    edit_button.click(
                        fn=self.edit_image,
                        inputs=[edit_input_image, edit_operation],
                        outputs=[edit_output_image, edit_output_info]
                    )

                # Tab 3: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ç·¨é›†
                with gr.Tab("ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ç·¨é›†"):
                    with gr.Row():
                        with gr.Column():
                            agent_input_image = gr.Image(
                                label="å…¥åŠ›ç”»åƒ",
                                type="pil"
                            )
                            agent_instruction = gr.Textbox(
                                label="ç·¨é›†æŒ‡ç¤º",
                                placeholder="ç”»åƒã‚’ã©ã®ã‚ˆã†ã«ç·¨é›†ã—ãŸã„ã‹èª¬æ˜ã—ã¦ãã ã•ã„",
                                lines=3
                            )
                            agent_button = gr.Button("ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä¾é ¼", variant="primary")

                        with gr.Column():
                            agent_output_image = gr.Image(label="ç·¨é›†å¾Œã®ç”»åƒ")
                            agent_output_info = gr.Markdown()

                    agent_button.click(
                        fn=self.agent_assisted_edit,
                        inputs=[agent_input_image, agent_instruction],
                        outputs=[agent_output_image, agent_output_info]
                    )

            # ãƒ•ãƒƒã‚¿ãƒ¼
            gr.Markdown("""
---
**nanobabana-editor** - ç”»åƒç”Ÿæˆãƒ»ç·¨é›†ãƒ„ãƒ¼ãƒ«
å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `output/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¾ã™
""")

        return demo


def main(test_mode: bool = False):
    """
    ãƒ¡ã‚¤ãƒ³å‡¦ç†

    Args:
        test_mode: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆUIã®ã¿èµ·å‹•ã€APIã‚­ãƒ¼ä¸è¦ï¼‰
    """
    # APIã‚­ãƒ¼ãŒãªã„å ´åˆã¯è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«
    if not test_mode:
        gcp_project_id = os.getenv("GCP_PROJECT_ID")
        gemini_api_key = os.getenv("GOOGLE_API_KEY")

        if not gcp_project_id and not gemini_api_key:
            print("=" * 60)
            print("âš  APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            print("=" * 60)
            print("ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã™ï¼ˆUIã®ã¿ã€ç”»åƒç”Ÿæˆã¯ç„¡åŠ¹ï¼‰")
            print()
            print("ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯:")
            print("1. .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ")
            print("2. ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’è¨­å®š:")
            print("   - GOOGLE_API_KEY (Geminiç”¨)")
            print("   - GCP_PROJECT_ID (Imagenç”¨)")
            print("=" * 60)
            print()
            test_mode = True

    app = NanobabanaApp(test_mode=test_mode)
    demo = app.create_ui()

    # ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•
    demo.launch(
        server_name="0.0.0.0",
        server_port=7860,
        share=False
    )


if __name__ == "__main__":
    import sys

    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’æŒ‡å®šå¯èƒ½
    test_mode = "--test" in sys.argv or "-t" in sys.argv

    main(test_mode=test_mode)
